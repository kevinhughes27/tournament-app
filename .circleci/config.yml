version: 2

jobs:
  build:
    working_directory: ~/ut

    docker:
      - image: circleci/ruby:2.3.4-node-browsers
      - image: circleci/postgres:9.4.12-alpine
      - image: redis:2.8.6

    environment:
      PGUSER: ubuntu
      RAILS_ENV: test
      RACK_ENV: test

    steps:
      # Checkout the source code
      - checkout
      - run: git submodule update --init

      # Restore bundle cache
      - type: cache-restore
        key: gemfile-{{ checksum "Gemfile.lock" }}

      # Bundle install dependencies
      - run: bundle install --with circleci --without production --without development --path vendor/bundle

      # Store bundle cache
      - type: cache-save
        key: gemfile-{{ checksum "Gemfile.lock" }}
        paths:
          - vendor/bundle

      # Restore yarn cache
      - restore_cache:
          key: yarn-{{ checksum "yarn.lock" }}

      # Yarn install dependencies
      - run: yarn install

      # Store yarn cache
      - save_cache:
          key: yarn-{{ checksum "yarn.lock" }}
          paths:
            - ./node_modules
            - ./client/node_modules
            - ./player-app/node_modules

      # Database setup
      - run: bundle exec rake db:create
      - run: bundle exec rake db:schema:load

      # Generate checksum for assets
      - type: shell
        command: |
          find app/assets/* -type f 2>/dev/null -exec md5sum {} \; > assets-checksum.txt
      - type: shell
        command: |
          git submodule status > player-app-checksum.txt

      # Restore assets cache
      - restore_cache:
          key: |
            assets
            {{ checksum "assets-checksum.txt" }}
            {{ checksum "player-app-checksum.txt" }}
            {{ checksum "Gemfile.lock" }}
            {{ checksum "client/yarn.lock" }}

      # Compile assets
      - run: bundle exec rake assets:precompile

      # Store assets cache
      - save_cache:
          key: |
            assets
            {{ checksum "assets-checksum.txt" }}
            {{ checksum "player-app-checksum.txt" }}
            {{ checksum "Gemfile.lock" }}
            {{ checksum "client/yarn.lock" }}
          paths:
            - public/assets
            - public/webpack
            - tmp/cache/assets
            - player-app/build

      # Run tests
      - run: bundle exec rake ci:all

      # Store Artifacts
      - store_artifacts:
          path: ~/ut/tmp/coverage
          destination: coverage

      - store_artifacts:
          path: ~/ut/tmp/capybara
          destination: capybara
